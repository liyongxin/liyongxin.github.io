<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: k8s | Earlene]]></title>
  <link href="http://liyongxin.github.io/blog/categories/k8s/atom.xml" rel="self"/>
  <link href="http://liyongxin.github.io/"/>
  <updated>2019-06-27T19:27:31+08:00</updated>
  <id>http://liyongxin.github.io/</id>
  <author>
    <name><![CDATA[yxli@alauda.io]]></name>
    <email><![CDATA[yxli@alauda.io]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[è®°å½•ä¸€æ¬¡é«˜å¯ç”¨é›†ç¾¤ä½¿ç”¨kubeadm v1.9.6å‡çº§v1.13 çš„é—®é¢˜]]></title>
    <link href="http://liyongxin.github.io/blog/2019/04/22/ji-lu-yi-ci-kubeadm-v1-dot-12sheng-ji-v1-dot-13-de-wen-ti/"/>
    <updated>2019-04-22T14:12:52+08:00</updated>
    <id>http://liyongxin.github.io/blog/2019/04/22/ji-lu-yi-ci-kubeadm-v1-dot-12sheng-ji-v1-dot-13-de-wen-ti</id>
    <content type="html"><![CDATA[<p>é¡¹ç›®ä¸­ä½¿ç”¨kubeadm å°†k8sç‰ˆæœ¬ä»v1.9.6å‡çº§åˆ°1.13.4,ç”±äºæ— æ³•è·¨ç‰ˆæœ¬å‡çº§ï¼Œæ‰€ä»¥å¤§è‡´æµç¨‹æ˜¯</p>

<ul>
<li>v1.9.6 -> v1.10.8</li>
<li>v1.10.8 -> v1.11.5</li>
<li>v1.11.5 -> v1.12.4</li>
<li>v1.12.4 -> v1.13.4</li>
</ul>


<p>å…¶ä¸­æ“ä½œé›†ç¾¤Aä»<code>v1.9.6</code>åˆ°<code>v1.10.8</code>å‡çº§è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œ<code>upgrade</code>çš„æ—¶å€™å‡ºç°äº†å¦‚ä¸‹é—®é¢˜ï¼š
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@cloud-cn-master-1 ~<span class="o">]</span><span class="c"># kubeadm upgrade apply v1.10.8 -y</span>
<span class="p">&amp;</span>hellip<span class="p">;</span>
<span class="o">[</span>upgrade/prepull<span class="o">]</span> Successfully prepulled the images <span class="k">for</span> all the control plane components
<span class="o">[</span>upgrade/apply<span class="o">]</span> Upgrading your Static Pod-hosted control plane to version <span class="p">&amp;</span>ldquo<span class="p">;</span>v1.10.8<span class="p">&amp;</span>rdquo<span class="p">;&amp;</span>hellip<span class="p">;</span>
Static pod: kube-apiserver-rz-dev-master01 <span class="nb">hash</span>: a82830fd687fdabd030b65ee6c4b4fd4
Static pod: kube-controller-manager-rz-dev-master01 <span class="nb">hash</span>: 1a23c184fadb64c889a41831476c56e8
Static pod: kube-scheduler-rz-dev-master01 <span class="nb">hash</span>: a0adc2bf23e7d5336ecd4677ce95938c
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Writing new Static Pod manifests to <span class="p">&amp;</span>ldquo<span class="p">;</span>/etc/kubernetes/tmp/kubeadm-upgraded-manifests500670946<span class="p">&amp;</span>rdquo<span class="p">;</span>
<span class="o">[</span>controlplane<span class="o">]</span> Adding extra host path mount <span class="p">&amp;</span>ldquo<span class="p">;</span>k8s<span class="p">&amp;</span>rdquo<span class="p">;</span> to <span class="p">&amp;</span>ldquo<span class="p">;</span>kube-controller-manager<span class="p">&amp;</span>rdquo<span class="p">;</span>
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> current and new manifests of kube-apiserver are equal, skipping upgrade
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Moved new manifest to <span class="p">&amp;</span>ldquo<span class="p">;</span>/etc/kubernetes/manifests/kube-controller-manager.yaml<span class="p">&amp;</span>rdquo<span class="p">;</span> and backed up old manifest to <span class="p">&amp;</span>ldquo<span class="p">;</span>/etc/kubernetes/tmp/kubeadm-backup-manifests-2019-04-22-13-04-58/kube-controller-manager.yaml<span class="p">&amp;</span>rdquo<span class="p">;</span>
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> Waiting <span class="k">for</span> the kubelet to restart the component
<span class="o">[</span>upgrade/staticpods<span class="o">]</span> This might take a minute or longer depending on the component/version gap <span class="o">(</span>timeout 5m0s<span class="o">)</span>
Static pod: kube-controller-manager-rz-dev-master01 <span class="nb">hash</span>: 1a23c184fadb64c889a41831476c56e8
Static pod: kube-controller-manager-rz-dev-master01 <span class="nb">hash</span>: 1a23c184fadb64c889a41831476c56e8
Static pod: kube-controller-manager-rz-dev-master01 <span class="nb">hash</span>: 1a23c184fadb64c889a41831476c56e8
Static pod: kube-controller-manager-rz-dev-master01 <span class="nb">hash</span>: 1a23c184fadb64c889a41831476c56e8
Static pod: kube-controller-manager-rz-dev-master01 <span class="nb">hash</span>: 1a23c184fadb64c889a41831476c56e8
<span class="p">&amp;</span>hellip<span class="p">;</span></code></pre></div></p>

<!--more-->


<p>å‡çº§è¿‡ç¨‹ä¸­ä¸€ç›´å¡åœ¨æ ¡éªŒ<code>hash</code>è¿™æ­¥ï¼Œç”±äºä¹‹å‰æµ‹è¯•æ²¡æœ‰å‡ºç°ç±»ä¼¼æƒ…å†µï¼Œè€Œæ­¤æ¬¡å‡ºé—®é¢˜å’Œæµ‹è¯•ç¯å¢ƒå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯è¯¥ç¯å¢ƒå‡çº§è¿‡è¯ä¹¦ï¼Œ
é»˜è®¤è¯ä¹¦æœ‰æ•ˆæœŸæ˜¯1å¹´ï¼Œæ­¤ç¯å¢ƒæ›´æ–°æˆ30å¹´äº†ï¼Œæ‰€ä»¥å°è¯•å…ˆæŠŠè¯ä¹¦è¿˜åŸåå†æ¬¡æ‰§è¡Œ<code>upgrade</code>ï¼Œå‡çº§æˆåŠŸï¼Œå…·ä½“åŸå› æœªæ’æŸ¥ã€‚</p>

<p>åœ¨å¦ä¸€ä¸ªç¯å¢ƒä»<code>v1.12</code>å‡çº§åˆ°<code>v1.13.4</code>ç‰ˆæœ¬æ—¶å€™ï¼Œå‡ºç°äº†å¦‚ä¸‹æƒ…å†µï¼š
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@cloud-cn-master-1 ~<span class="o">]</span><span class="c"># kubeadm upgrade apply v1.13.4 -y</span>
<span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks.
<span class="o">[</span>upgrade<span class="o">]</span> Making sure the cluster is healthy:
<span class="o">[</span>upgrade/config<span class="o">]</span> Making sure the configuration is correct:
<span class="o">[</span>upgrade/config<span class="o">]</span> Reading configuration from the cluster<span class="p">&amp;</span>hellip<span class="p">;</span>
<span class="o">[</span>upgrade/config<span class="o">]</span> FYI: You can look at this config file with <span class="p">&amp;</span>lsquo<span class="p">;</span>kubectl -n kube-system get cm kubeadm-config -oyaml<span class="p">&amp;</span>rsquo<span class="p">;</span>
FATAL: failed to get node registration: node doesn<span class="p">&amp;</span>rsquo<span class="p">;</span>t have kubeadm.alpha.kubernetes.io/cri-socket annotation</code></pre></div></p>

<p>æŠ¥é”™æç¤º<code>node</code>ç¼ºå°‘<code>annotation</code>ï¼Œè€ŒæŸ¥çœ‹æ“ä½œ<code>kubeadm</code>å‡çº§çš„<code>master node</code>ï¼Œæ˜¯å­˜åœ¨<code>cri-socket</code>çš„<code>annotation</code>çš„ï¼Œä½†æ˜¯å…¶ä»–ä¸¤å°<code>master</code>
ä¸å­˜åœ¨ï¼Œäºæ˜¯å°è¯•æ‰‹åŠ¨æ·»åŠ <code>annotation</code>ï¼Œç„¶åå†æ¬¡è·‘<code>upgrade</code>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@cloud-cn-master-1 ~<span class="o">]</span><span class="c"># kubectl annotate node &lt;nodename&gt; kubeadm.alpha.kubernetes.io/cri-socket=/var/run/dockershim.sock</span>
<span class="o">[</span>root@cloud-cn-master-1 ~<span class="o">]</span><span class="c"># kubeadm upgrade apply v1.13.4 -y</span>
<span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks.
<span class="o">[</span>upgrade<span class="o">]</span> Making sure the cluster is healthy:
<span class="o">[</span>upgrade/config<span class="o">]</span> Making sure the configuration is correct:
<span class="o">[</span>upgrade/config<span class="o">]</span> Reading configuration from the cluster<span class="p">&amp;</span>hellip<span class="p">;</span>
<span class="o">[</span>upgrade/config<span class="o">]</span> FYI: You can look at this config file with <span class="p">&amp;</span>lsquo<span class="p">;</span>kubectl -n kube-system get cm kubeadm-config -oyaml<span class="p">&amp;</span>rsquo<span class="p">;</span>
<span class="o">[</span>upgrade/config<span class="o">]</span> FATAL: failed to getAPIEndpoint: failed to get APIEndpoint information <span class="k">for</span> this node</code></pre></div>
åˆæŠ¥é”™æ‰¾ä¸åˆ°<code>APIEndpoint</code>ï¼Œå°è¯•æ‰§è¡Œçœ‹ä¸‹<code>kubeadm-config</code>çš„æ•°æ®
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@cloud-cn-master-1 ~<span class="o">]</span><span class="c"># kubectl -n kube-system get cm kubeadm-config -oyaml|grep -A5 cloud-cn-master-1</span>
  ClusterStatus: <span class="p">|</span>
    apiEndpoints:
      cloud-cn-master-1:
        advertiseAddress: 10.0.128.251
        bindPort: 6443
    apiVersion: kubeadm.k8s.io/v1beta1
    kind: ClusterStatus</code></pre></div></p>

<p>å‘ç°è¯¥<code>apiEndpoints</code>æ˜¯å­˜åœ¨çš„ï¼Œä½†æ˜¯åªå­˜åœ¨è¿™ä¸€ä¸ªèŠ‚ç‚¹ï¼Œäºæ˜¯å°è¯•<code>edit cm</code>æŠŠå¦å¤–ä¸¤ä¸ªèŠ‚ç‚¹çš„<code>apiEndpoint</code>ä¹Ÿé…ç½®ä¸Šï¼Œå†æ¬¡<code>upgrade</code>ï¼Œ
å‘ç°åˆå‡ºç°äº†æ ¡éªŒ<code>hash</code>ä¸é€šè¿‡çš„é”™è¯¯ï¼Œäºæ˜¯å°è¯•å»çœ‹ä¸‹<code>kubeadm</code>çš„æºç ï¼Œç†æ¸…æ¥šè¿™ä¸ª<code>config</code>é˜¶æ®µçš„æ€è·¯ï¼Œ
æºç å¯ä»¥å‚è€ƒ<a href="https://github.com/kubernetes/kubernetes/blob/master/cmd/kubeadm/app/util/config/cluster.go">æ­¤å¤„</a>,
<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="c1">// if this isn&amp;rsquo;t a new controlplane instance (e.g. in case of kubeadm upgrades)</span>
<span class="c1">// get nodes specific information as well</span>
<span class="k">if</span> <span class="p">!</span><span class="nx">newControlPlane</span> <span class="p">{</span>
    <span class="c1">// gets the nodeRegistration for the current from the node object</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">getNodeRegistration</span><span class="p">(</span><span class="nx">kubeconfigDir</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span><span class="nx">initcfg</span><span class="p">.</span><span class="nx">NodeRegistration</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">failed</span> <span class="nx">to</span> <span class="nx">get</span> <span class="nx">node</span> <span class="nx">registration</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;)</span>
    <span class="p">}</span>
    <span class="c1">// gets the APIEndpoint for the current node from then ClusterStatus in the kubeadm-config ConfigMap</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">getAPIEndpoint</span><span class="p">(</span><span class="nx">configMap</span><span class="p">.</span><span class="nx">Data</span><span class="p">,</span> <span class="nx">initcfg</span><span class="p">.</span><span class="nx">NodeRegistration</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span><span class="nx">initcfg</span><span class="p">.</span><span class="nx">LocalAPIEndpoint</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">failed</span> <span class="nx">to</span> <span class="nx">getAPIEndpoint</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div></p>

<p>è¯¥éƒ¨åˆ†å³å¯¹åº”æ‰§è¡Œ<code>upgrade</code>çš„é€»è¾‘ï¼Œå…ˆå»<code>getNodeRegistration</code>ç„¶åå»<code>getAPIEndpoint</code>ï¼Œçœ‹ä¸‹getAPIEndpointçš„é€»è¾‘
<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="c1">// getAPIEndpoint returns the APIEndpoint for the current node</span>
<span class="kd">func</span> <span class="nx">getAPIEndpoint</span><span class="p">(</span><span class="nx">data</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">nodeName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">apiEndpoint</span> <span class="o">*</span><span class="nx">kubeadmapi</span><span class="p">.</span><span class="nx">APIEndpoint</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c1">// gets the ClusterStatus from kubeadm-config</span>
    <span class="nx">clusterStatus</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">UnmarshalClusterStatus</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}&lt;</span><span class="o">/</span><span class="nx">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nx">pre</span><span class="p">&gt;&lt;</span><span class="nx">code</span><span class="p">&gt;</span><span class="c1">// gets the APIEndpoint for the current machine from the ClusterStatus</span>
<span class="nx">e</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">clusterStatus</span><span class="p">.</span><span class="nx">APIEndpoints</span><span class="p">[</span><span class="nx">nodeName</span><span class="p">]</span>
<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;failed to get APIEndpoint information for this node&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">apiEndpoint</span><span class="p">.</span><span class="nx">AdvertiseAddress</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">AdvertiseAddress</span>
<span class="nx">apiEndpoint</span><span class="p">.</span><span class="nx">BindPort</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">BindPort</span>
<span class="k">return</span> <span class="kc">nil</span>
<span class="p">&lt;</span><span class="o">/</span><span class="nx">code</span><span class="p">&gt;&lt;</span><span class="o">/</span><span class="nx">pre</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nx">p</span><span class="p">&gt;}</span></code></pre></div>
ä¼šæ ¹æ®<code>nodeName</code>å’Œ<code>kubeadm-config</code>è¿™ä¸ª<code>configmap</code>çš„æ•°æ®å»æ‹¿<code>APIEndpoint</code>çš„<code>AdvertiseAddress</code>å’Œ<code>BindPort</code>ä¿¡æ¯ï¼Œä½†æ˜¯æ‰‹åŠ¨ç¡®è®¤è¿‡ç¡®å®æ˜¯å­˜åœ¨
<code>APIEndpoint</code>çš„é…ç½®çš„ï¼Œæ‰€ä»¥å†æ¬¡æŸ¥çœ‹ä¼ è¿‡æ¥çš„<code>nodeName</code>æ˜¯å¦æ­£ç¡®ï¼Œç”±äº<code>nodeName</code>æ˜¯ä»<code>NodeRegistration</code>ä¸­è·å–çš„å…ˆçœ‹ä¸‹<code>NodeRegistration</code>çš„è·å–é€»è¾‘:</p>

<p><div class="highlight"><pre><code class="language-go" data-lang="go"><span class="c1">// getNodeRegistration returns the nodeRegistration for the current node</span>
<span class="kd">func</span> <span class="nx">getNodeRegistration</span><span class="p">(</span><span class="nx">kubeconfigDir</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">client</span> <span class="nx">clientset</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">nodeRegistration</span> <span class="o">*</span><span class="nx">kubeadmapi</span><span class="p">.</span><span class="nx">NodeRegistrationOptions</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c1">// gets the name of the current node</span>
    <span class="nx">nodeName</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">getNodeNameFromKubeletConfig</span><span class="p">(</span><span class="nx">kubeconfigDir</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">failed</span> <span class="nx">to</span> <span class="nx">get</span> <span class="nx">node</span> <span class="nx">name</span> <span class="nx">from</span> <span class="nx">kubelet</span> <span class="nx">config</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;)</span>
    <span class="p">}&lt;</span><span class="o">/</span><span class="nx">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nx">pre</span><span class="p">&gt;&lt;</span><span class="nx">code</span><span class="p">&gt;</span><span class="c1">// gets the corresponding node and retrieves attributes stored there.</span>
<span class="nx">node</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">CoreV1</span><span class="p">().</span><span class="nx">Nodes</span><span class="p">().</span><span class="nx">Get</span><span class="p">(</span><span class="nx">nodeName</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">{})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&quot;failed to get corresponding node&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">criSocket</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">[</span><span class="nx">constants</span><span class="p">.</span><span class="nx">AnnotationKubeadmCRISocket</span><span class="p">]</span>
<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;node %s doesn&#39;t have %s annotation&quot;</span><span class="p">,</span> <span class="nx">nodeName</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">AnnotationKubeadmCRISocket</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// returns the nodeRegistration attributes</span>
<span class="nx">nodeRegistration</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="nx">nodeName</span>
<span class="nx">nodeRegistration</span><span class="p">.</span><span class="nx">CRISocket</span> <span class="p">=</span> <span class="nx">criSocket</span>
<span class="nx">nodeRegistration</span><span class="p">.</span><span class="nx">Taints</span> <span class="p">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Taints</span>
<span class="c1">// NB. currently nodeRegistration.KubeletExtraArgs isn&#39;t stored at node level but only in the kubeadm-flags.env</span>
<span class="c1">//     that isn&#39;t modified during upgrades</span>
<span class="c1">//     in future we might reconsider this thus enabling changes to the kubeadm-flags.env during upgrades as well</span>
<span class="k">return</span> <span class="kc">nil</span>
<span class="p">&lt;</span><span class="o">/</span><span class="nx">code</span><span class="p">&gt;&lt;</span><span class="o">/</span><span class="nx">pre</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nx">p</span><span class="p">&gt;}</span></code></pre></div>
å‘ç°<code>nodeName</code>æ˜¯é€šè¿‡<code>getNodeNameFromKubeletConfig</code>è·å–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¯»å–çš„æ˜¯<code>kubelet.conf</code>é…ç½®ï¼Œçœ‹ä¸‹<code>getNodeNameFromKubeletConfig</code>é€»è¾‘ï¼š
<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="c1">// getNodeNameFromConfig gets the node name from a kubelet config file</span>
<span class="c1">// TODO: in future we want to switch to a more canonical way for doing this e.g. by having this</span>
<span class="c1">//       information in the local kubelet config.yaml</span>
<span class="kd">func</span> <span class="nx">getNodeNameFromKubeletConfig</span><span class="p">(</span><span class="nx">kubeconfigDir</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// loads the kubelet.conf file</span>
    <span class="nx">fileName</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">kubeconfigDir</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">KubeletKubeConfigFileName</span><span class="p">)</span>
    <span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nx">LoadFromFile</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;,</span> <span class="nx">err</span>
    <span class="p">}&lt;</span><span class="o">/</span><span class="nx">p</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nx">pre</span><span class="p">&gt;&lt;</span><span class="nx">code</span><span class="p">&gt;</span><span class="c1">// gets the info about the current user</span>
<span class="nx">authInfo</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">AuthInfos</span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">Contexts</span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">CurrentContext</span><span class="p">].</span><span class="nx">AuthInfo</span><span class="p">]</span>

<span class="c1">// gets the X509 certificate with current user credentials</span>
<span class="kd">var</span> <span class="nx">certs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">x509</span><span class="p">.</span><span class="nx">Certificate</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">authInfo</span><span class="p">.</span><span class="nx">ClientCertificateData</span><span class="p">)</span> <span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="c1">// if the config file uses an embedded x509 certificate (e.g. kubelet.conf created by kubeadm), parse it</span>
    <span class="k">if</span> <span class="nx">certs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">certutil</span><span class="p">.</span><span class="nx">ParseCertsPEM</span><span class="p">(</span><span class="nx">authInfo</span><span class="p">.</span><span class="nx">ClientCertificateData</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">authInfo</span><span class="p">.</span><span class="nx">ClientCertificate</span><span class="p">)</span> <span class="o">&amp;</span><span class="nx">gt</span><span class="p">;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="c1">// if the config file links an external x509 certificate (e.g. kubelet.conf created by TLS bootstrap), load it</span>
    <span class="k">if</span> <span class="nx">certs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">certutil</span><span class="p">.</span><span class="nx">CertsFromFile</span><span class="p">(</span><span class="nx">authInfo</span><span class="p">.</span><span class="nx">ClientCertificate</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;invalid kubelet.conf. X509 certificate expected&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// We are only putting one certificate in the certificate pem file, so it&#39;s safe to just pick the first one</span>
<span class="c1">// TODO: Support multiple certs here in order to be able to rotate certs</span>
<span class="nx">cert</span> <span class="o">:=</span> <span class="nx">certs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1">// gets the node name from the certificate common name</span>
<span class="k">return</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">TrimPrefix</span><span class="p">(</span><span class="nx">cert</span><span class="p">.</span><span class="nx">Subject</span><span class="p">.</span><span class="nx">CommonName</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">NodesUserPrefix</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">&lt;</span><span class="o">/</span><span class="nx">code</span><span class="p">&gt;&lt;</span><span class="o">/</span><span class="nx">pre</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nx">p</span><span class="p">&gt;}</span></code></pre></div>
å‘ç°kubeadmå…ˆåŠ è½½æœ¬æœºçš„<code>kubelet.conf</code>æ–‡ä»¶ï¼Œç„¶åå°è¯•å»æ‰¾å½“å‰contextä¸­é…ç½®çš„ç”¨æˆ·çš„client-certificate-dataæ•°æ®ï¼Œç„¶åè§£æcert
çš„ä¿¡æ¯ï¼Œæ‰¾åˆ°subjectçš„CommanName,æ¥å½“ä½œNodeNameç„¶åå»kubeadm-configä¸­æ‰¾å¯¹åº”çš„apiEndpoint,æ‰€ä»¥å°è¯•è§£æä¸‹å½“å‰çš„è¯ä¹¦æ•°æ®ï¼Œçœ‹ä¸‹CNçš„å€¼ï¼š
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">å…ˆè·å–</span><span class="n">client</span><span class="o">-</span><span class="n">certificate</span><span class="o">-</span><span class="n">data</span><span class="err">å¹¶åš</span><span class="n">base64</span><span class="err">è§£å¯†å¾—åˆ°</span><span class="n">cert</span><span class="err">ä¿¡æ¯</span><span class="p">,</span><span class="err">$</span><span class="n">client</span><span class="o">-</span><span class="n">certificate</span><span class="o">-</span><span class="n">data</span><span class="err">ä¸º</span><span class="n">kubelet</span><span class="o">.</span><span class="n">conf</span><span class="err">ä¸­</span><span class="n">client</span><span class="o">-</span><span class="n">certificate</span><span class="o">-</span><span class="n">data</span><span class="err">å¯¹åº”çš„å†…å®¹</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">[</span><span class="n">root</span><span class="nd">@cloud</span><span class="o">-</span><span class="n">cn</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="mi">1</span> <span class="o">~</span><span class="p">]</span><span class="c"># echo $client-certificate-data |base64 -d &gt; kubelet.crt</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@cloud</span><span class="o">-</span><span class="n">cn</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="mi">1</span> <span class="o">~</span><span class="p">]</span><span class="c"># openssl x509 -in kubelet.crt -text |grep -i Subject</span>
        <span class="n">Subject</span><span class="p">:</span> <span class="n">O</span><span class="o">=</span><span class="n">system</span><span class="p">:</span><span class="n">nodes</span><span class="p">,</span> <span class="n">CN</span><span class="o">=</span><span class="n">system</span><span class="p">:</span><span class="n">node</span><span class="p">:</span><span class="n">cloud</span><span class="o">-</span><span class="n">cn</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="mi">2</span>
        <span class="n">Subject</span> <span class="n">Public</span> <span class="n">Key</span> <span class="n">Info</span><span class="p">:</span></code></pre></div>
ğŸ‘†ï¼Œå¥½å§åŸå› å®šä½åˆ°äº†ï¼Œæ˜¯å› ä¸ºè·å–åˆ°çš„<code>CommanName</code>ä¸æœ¬æœºä¸åŒ¹é…ï¼Œäºæ˜¯åœ¨<code>cloud-cn-master-1</code>ä¸Šè·å–åˆ°çš„æ˜¯<code>cloud-cn-master-2</code>çš„<code>nodeName</code>ï¼Œ
ç„¶åå»è·å–<code>annotation</code>è‡ªç„¶ä¹Ÿå°±æ‹¿ä¸åˆ°äº†ï¼Œç„¶åå³ä½¿æ‰‹åŠ¨<code>annotate</code>äº†ï¼Œä¹Ÿæ˜¯ä¸´æ—¶è¿‡äº†ä¸€æ­¥ï¼Œåˆ°<code>configmap</code>ä¸­å–<code>apiEndpoint</code>è‡ªç„¶ä¹Ÿè·å–ä¸åˆ°ï¼Œ
å“ªæ€•å†æ‰‹åŠ¨ç»´æŠ¤<code>apiEndpoint</code>ï¼Œé‚£ä¹ˆåç»­åˆ°æ ¡éªŒhashä¹Ÿæ˜¯æ— æ³•é€šè¿‡ï¼Œæ‰€ä»¥æ ¹æœ¬åŸå› åœ¨äºå‡çº§è¯ä¹¦çš„æ—¶å€™æ²¡æœ‰<code>kubelet</code>è¯ä¹¦è¢«è¦†ç›–äº†ï¼Œå¯¼è‡´ä¸€ç³»åˆ—çš„é—®é¢˜</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[kubernetesçš„service cluster ip]]></title>
    <link href="http://liyongxin.github.io/blog/2019/04/03/kubernetesde-service-cluster-ip/"/>
    <updated>2019-04-03T17:17:23+08:00</updated>
    <id>http://liyongxin.github.io/blog/2019/04/03/kubernetesde-service-cluster-ip</id>
    <content type="html"><![CDATA[<p>k8sçš„podå¯ä»¥æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œä½†æ˜¯åœ¨è®¿é—®podæ—¶ï¼Œä¼šæœ‰å‡ ä¸ªé—®é¢˜ï¼š</p>

<ul>
<li>å®¢æˆ·ç«¯éœ€è¦çŸ¥é“å„ä¸ªpodçš„åœ°å€</li>
<li>æŸä¸€nodeä¸Šçš„podå¦‚æœæ•…éšœï¼Œå®¢æˆ·ç«¯éœ€è¦æ„ŸçŸ¥</li>
</ul>


<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œk8så¼•å…¥äº†serviceçš„æ¦‚å¿µï¼Œç”¨ä»¥æŒ‡å¯¼å®¢æˆ·ç«¯çš„æµé‡ã€‚</p>

<h2>Service</h2>

<p>ä»¥ä¸‹é¢çš„my-nginxä¸ºä¾‹ã€‚</p>

<p>podå’Œserviceçš„å®šä¹‰æ–‡ä»¶å¦‚ä¸‹ï¼š
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@localhost k8s<span class="o">]</span><span class="c"># cat run-my-nginx.yaml</span>
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: my-nginx
spec:
  replicas: 2
  template:
    metadata:
      labels:
        run: my-nginx
    spec:
      containers:
      - name: my-nginx
        image: nginx
        ports:
        - containerPort: 80
<span class="o">[</span>root@localhost k8s<span class="o">]</span><span class="c"># cat run-my-nginx-service.yaml</span>
apiVersion: v1
kind: Service
metadata:
  name: my-nginx
  labels:
    run: my-nginx
spec:
  ports:
  - port: 80
    protocol: TCP
  selector:
    run: my-nginx</code></pre></div></p>

<p>pod my-nginxå®šä¹‰çš„replicasä¸º2å³2ä¸ªå‰¯æœ¬ï¼Œç«¯å£å·ä¸º80;service my-nginxå®šä¹‰çš„selectorä¸ºrun:my-nginxï¼Œå³è¯¥serviceé€‰ä¸­æ‰€æœ‰labelä¸ºrun: my-nginxçš„podï¼›å®šä¹‰çš„portä¸º80ã€‚</p>

<!--more-->


<p>ä½¿ç”¨kubectl create -f xx.ymlåˆ›å»ºåï¼Œå¯ä»¥åœ¨é›†ç¾¤ä¸Šçœ‹åˆ°2ä¸ªpodï¼Œåœ°å€åˆ†åˆ«ä¸º10.244.1.10/10.244.2.10ï¼›å¯ä»¥çœ‹åˆ°1ä¸ªserviceï¼ŒIP/Portä¸º10.11.97.177/80ï¼Œå…¶å¯¹æ¥çš„Endpointsä¸º10.244.1.10:80,10.244.2.10:80ï¼Œå³2ä¸ªpodçš„æœåŠ¡åœ°å€ï¼Œè¿™ä¸‰ä¸ªURLåœ¨é›†ç¾¤å†…ä»»ä¸€èŠ‚ç‚¹éƒ½å¯ä»¥ä½¿ç”¨curlè®¿é—®ã€‚
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@localhost k8s<span class="o">]</span><span class="c"># kubectl get pods -n default -o wide</span>
NAME                       READY     STATUS    RESTARTS   AGE       IP            NODE
my-nginx-379829228-3n755   1/1       Running   <span class="m">0</span>          21h       10.244.1.10   note2
my-nginx-379829228-xh214   1/1       Running   <span class="m">0</span>          21h       10.244.2.10   node1
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c">#</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c"># kubectl describe svc my-nginx</span>
Name:                   my-nginx
Namespace:              default
Labels:                 <span class="nv">run</span><span class="o">=</span>my-nginx
Selector:               <span class="nv">run</span><span class="o">=</span>my-nginx
Type:                   ClusterIP
IP:                     10.11.97.177
Port:                   &lt;<span class="nb">unset</span>&gt; 80/TCP
Endpoints:              10.244.1.10:80,10.244.2.10:80
Session Affinity:       None</code></pre></div></p>

<p>ä½†æ˜¯ï¼Œå¦‚æœä½ å»æŸ¥çœ‹é›†ç¾¤å„èŠ‚ç‚¹çš„IPä¿¡æ¯ï¼Œæ˜¯æ‰¾ä¸åˆ°10.11.97.177è¿™ä¸ªIPçš„ï¼Œé‚£ä¹ˆcurlæ˜¯å¦‚ä½•é€šè¿‡è¿™ä¸ª(Virtual)IPåœ°å€è®¿é—®åˆ°åç«¯çš„Endpointså‘¢ï¼Ÿ
ç­”æ¡ˆåœ¨<a href="https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies">è¿™é‡Œ</a>ã€‚</p>

<h2>kube-proxy</h2>

<p>k8sæ”¯æŒ2ç§proxyæ¨¡å¼ï¼Œuserspaceå’Œiptablesã€‚ä»v1.2ç‰ˆæœ¬å¼€å§‹ï¼Œé»˜è®¤é‡‡ç”¨iptables proxyã€‚é‚£ä¹ˆè¿™ä¸¤ç§æ¨¡å¼æœ‰ä»€ä¹ˆä¸åŒå—ï¼Ÿ</p>

<p>1ã€userspace</p>

<p>é¡¾åæ€ä¹‰ï¼Œuserspaceå³ç”¨æˆ·ç©ºé—´ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆå«å‘¢ï¼Ÿçœ‹ä¸‹é¢çš„å›¾ã€‚</p>

<p><img src="/images/custom/services-userspace-overview.svg" alt="" /></p>

<p>kube-proxyä¼šä¸ºæ¯ä¸ªserviceéšæœºç›‘å¬ä¸€ä¸ªç«¯å£(proxy port)ï¼Œå¹¶å¢åŠ ä¸€æ¡iptablesè§„åˆ™ï¼šæ‰€ä»¥åˆ°clusterIP:Port çš„æŠ¥æ–‡éƒ½redirectåˆ°proxy portï¼›kube-proxyä»å®ƒç›‘å¬çš„proxy portæ”¶åˆ°æŠ¥æ–‡åï¼Œèµ°round robinï¼ˆé»˜è®¤ï¼‰æˆ–è€…session affinityï¼ˆä¼šè¯äº²å’ŒåŠ›ï¼Œå³åŒä¸€client IPéƒ½èµ°åŒä¸€é“¾è·¯ç»™åŒä¸€podæœåŠ¡ï¼‰ï¼Œåˆ†å‘ç»™å¯¹åº”çš„podã€‚</p>

<p>æ˜¾ç„¶userspaceä¼šé€ æˆæ‰€æœ‰æŠ¥æ–‡éƒ½èµ°ä¸€éç”¨æˆ·æ€ï¼Œæ€§èƒ½ä¸é«˜ï¼Œç°åœ¨k8så·²ç»ä¸å†ä½¿ç”¨äº†ã€‚</p>

<p>2ã€iptables</p>

<p>æˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹çœ‹userspaceï¼Œæ—¢ç„¶ç”¨æˆ·æ€ä¼šå¢åŠ æ€§èƒ½æŸè€—ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•ä¸èµ°å‘¢ï¼Ÿå®é™…ä¸Šç”¨æˆ·æ€ä¹Ÿåªæ˜¯ä¸€ä¸ªæŠ¥æ–‡LBï¼Œé€šè¿‡iptableså®Œå…¨å¯ä»¥æå®šã€‚k8sä¸‹é¢è¿™å¼ å›¾å¾ˆæ¸…æ™°çš„è¯´æ˜äº†iptablesæ–¹å¼ä¸userspaceæ–¹å¼çš„ä¸åŒï¼škube-proxyåªæ˜¯ä½œä¸ºcontrollerï¼Œè€Œä¸æ˜¯serverï¼ŒçœŸæ­£æœåŠ¡çš„æ˜¯å†…æ ¸çš„netfilterï¼Œä½“ç°åœ¨ç”¨æˆ·æ€åˆ™æ˜¯iptablesã€‚</p>

<p>kube-proxyçš„iptablesæ–¹å¼ä¹Ÿæ”¯æŒround robin(é»˜è®¤)å’Œsession affinityã€‚</p>

<p><img src="/images/custom/services-iptables-overview.svg" alt="" /></p>

<p>é‚£ä¹ˆiptablesæ˜¯æ€ä¹ˆåšåˆ°LBï¼Œè€Œä¸”è¿˜èƒ½round-robinå‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡iptables-saveæ¥çœ‹my-nginxè¿™ä¸ªæœåŠ¡åœ¨æŸä¸€ä¸ªnodeä¸Šçš„iptablesè§„åˆ™ã€‚
<div class="highlight"><pre><code class="language-bash" data-lang="bash">-A KUBE-SERVICES -d 10.11.97.177/32 -p tcp -m comment <span class="p">&amp;</span>ndash<span class="p">;</span>comment <span class="p">&amp;</span>ldquo<span class="p">;</span>default/my-nginx: cluster IP<span class="p">&amp;</span>rdquo<span class="p">;</span> -m tcp <span class="p">&amp;</span>ndash<span class="p">;</span>dport <span class="m">80</span> -j KUBE-SVC-BEPXDJBUHFCSYIC3&lt;/p&gt;

&lt;p&gt;-A KUBE-SVC-BEPXDJBUHFCSYIC3 -m comment <span class="p">&amp;</span>ndash<span class="p">;</span>comment <span class="p">&amp;</span>ldquo<span class="p">;</span>default/my-nginx:<span class="p">&amp;</span>rdquo<span class="p">;</span> -m statistic <span class="p">&amp;</span>ndash<span class="p">;</span>mode random <span class="p">&amp;</span>ndash<span class="p">;</span>probability 0.50000000000 -j KUBE-SEP-U4UWLP4OR3LOJBXU
-A KUBE-SVC-BEPXDJBUHFCSYIC3 -m comment <span class="p">&amp;</span>ndash<span class="p">;</span>comment <span class="p">&amp;</span>ldquo<span class="p">;</span>default/my-nginx:<span class="p">&amp;</span>rdquo<span class="p">;</span> -j KUBE-SEP-QHRWSLKOO5YUPI7O&lt;/p&gt;

&lt;p&gt;-A KUBE-SEP-U4UWLP4OR3LOJBXU -s 10.244.1.10/32 -m comment <span class="p">&amp;</span>ndash<span class="p">;</span>comment <span class="p">&amp;</span>ldquo<span class="p">;</span>default/my-nginx:<span class="p">&amp;</span>rdquo<span class="p">;</span> -j KUBE-MARK-MASQ
-A KUBE-SEP-U4UWLP4OR3LOJBXU -p tcp -m comment <span class="p">&amp;</span>ndash<span class="p">;</span>comment <span class="p">&amp;</span>ldquo<span class="p">;</span>default/my-nginx:<span class="p">&amp;</span>rdquo<span class="p">;</span> -m tcp -j DNAT <span class="p">&amp;</span>ndash<span class="p">;</span>to-destination 10.244.1.10:80&lt;/p&gt;

&lt;p&gt;-A KUBE-SEP-QHRWSLKOO5YUPI7O -s 10.244.2.10/32 -m comment <span class="p">&amp;</span>ndash<span class="p">;</span>comment <span class="p">&amp;</span>ldquo<span class="p">;</span>default/my-nginx:<span class="p">&amp;</span>rdquo<span class="p">;</span> -j KUBE-MARK-MASQ
-A KUBE-SEP-QHRWSLKOO5YUPI7O -p tcp -m comment <span class="p">&amp;</span>ndash<span class="p">;</span>comment <span class="p">&amp;</span>ldquo<span class="p">;</span>default/my-nginx:<span class="p">&amp;</span>rdquo<span class="p">;</span> -m tcp -j DNAT <span class="p">&amp;</span>ndash<span class="p">;</span>to-destination 10.244.2.10:80</code></pre></div></p>

<p>ç¬¬1æ¡è§„åˆ™ï¼Œç»ˆäºçœ‹åˆ°è¿™ä¸ªvirtual IPäº†ã€‚nodeä¸Šä¸éœ€è¦æœ‰è¿™ä¸ªipåœ°å€ï¼Œiptablesåœ¨çœ‹åˆ°ç›®çš„åœ°å€ä¸ºvirutal ipçš„ç¬¦åˆè§„åˆ™tcpæŠ¥æ–‡ï¼Œä¼šèµ°KUBE-SVC-BEPXDJBUHFCSYIC3è§„åˆ™ã€‚</p>

<p>ç¬¬2/3æ¡è§„åˆ™ï¼ŒKUBE-SVC-BEPXDJBUHFCSYIC3é“¾å®ç°äº†å°†æŠ¥æ–‡æŒ‰50%çš„ç»Ÿè®¡æ¦‚ç‡éšæœºåŒ¹é…åˆ°2æ¡è§„åˆ™(round-robin)ã€‚</p>

<p>ç¬¬4/5å’Œ5/6ä¸ºæˆå¯¹çš„2ç»„è§„åˆ™ï¼Œå°†æŠ¥æ–‡è½¬ç»™äº†çœŸæ­£çš„æœåŠ¡podã€‚</p>

<p>è‡³æ­¤ï¼Œä»ç‰©ç†nodeæ”¶åˆ°ç›®çš„åœ°å€ä¸º10.11.97.177ã€ç«¯å£å·ä¸º80çš„æŠ¥æ–‡å¼€å§‹ï¼Œåˆ°pod my-nginxæ”¶åˆ°æŠ¥æ–‡å¹¶å“åº”ï¼Œæè¿°äº†ä¸€ä¸ªå®Œæ•´çš„é“¾è·¯ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªæŠ¥æ–‡é“¾è·¯ä¸Šæ²¡æœ‰ç»è¿‡ä»»ä½•ç”¨æˆ·æ€è¿›ç¨‹ï¼Œæ•ˆç‡å’Œç¨³å®šæ€§éƒ½æ¯”è¾ƒé«˜ã€‚</p>

<h2>NodePort</h2>

<p>ä¸Šé¢çš„ä¾‹å­é‡Œï¼Œç”±äº10.11.97.177å…¶å®è¿˜æ˜¯åœ¨é›†ç¾¤å†…æœ‰æ•ˆåœ°å€ï¼Œç”±äºå®é™…ä¸Šå¹¶ä¸å­˜åœ¨è¿™ä¸ªåœ°å€ï¼Œå½“ä»é›†ç¾¤å¤–è®¿é—®æ—¶ä¼šè®¿é—®å¤±è´¥ï¼Œè¿™æ—¶éœ€è¦å°†serviceæš´æ¼å‡ºå»ã€‚k8sç»™å‡ºçš„ä¸€ä¸ªæ–¹æ¡ˆæ˜¯NodePortï¼Œå®¢æˆ·ç«¯æ ¹æ®NodePort+é›†ç¾¤å†…ä»»ä¸€ç‰©ç†èŠ‚ç‚¹çš„IPï¼Œå°±å¯ä»¥è®¿é—®k8sçš„serviceäº†ã€‚è¿™åˆæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ</p>

<p>ç­”æ¡ˆè¿˜æ˜¯iptablesã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™ä¸ªsock-shopçš„ä¾‹å­ï¼Œå…¶åˆ›å»ºæ–¹æ³•è§k8s.ioï¼Œä¸å†èµ˜è¿°ã€‚
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@localhost k8s<span class="o">]</span><span class="c"># kubectl describe svc front-end -n sock-shop</span>
Name:                   front-end
Namespace:              sock-shop
Labels:                 <span class="nv">name</span><span class="o">=</span>front-end
Selector:               <span class="nv">name</span><span class="o">=</span>front-end
Type:                   NodePort
IP:                     10.15.9.0
Port:                   &lt;<span class="nb">unset</span>&gt; 80/TCP
NodePort:               &lt;<span class="nb">unset</span>&gt; 30001/TCP
Endpoints:              10.244.2.5:8079
Session Affinity:       None</code></pre></div></p>

<p>åœ¨ä»»ä¸€nodeä¸ŠæŸ¥çœ‹iptables-saveï¼š
<div class="highlight"><pre><code class="language-bash" data-lang="bash">-A KUBE-NODEPORTS -p tcp -m comment <span class="p">&amp;</span>ndash<span class="p">;</span>comment <span class="p">&amp;</span>ldquo<span class="p">;</span>sock-shop/front-end:<span class="p">&amp;</span>rdquo<span class="p">;</span> -m tcp <span class="p">&amp;</span>ndash<span class="p">;</span>dport <span class="m">30001</span> -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment <span class="p">&amp;</span>ndash<span class="p">;</span>comment <span class="p">&amp;</span>ldquo<span class="p">;</span>sock-shop/front-end:<span class="p">&amp;</span>rdquo<span class="p">;</span> -m tcp <span class="p">&amp;</span>ndash<span class="p">;</span>dport <span class="m">30001</span> -j KUBE-SVC-LFMD53S3EZEAOUSJ&lt;/p&gt;

&lt;p&gt;-A KUBE-SERVICES -d 10.15.9.0/32 -p tcp -m comment <span class="p">&amp;</span>ndash<span class="p">;</span>comment <span class="p">&amp;</span>ldquo<span class="p">;</span>sock-shop/front-end: cluster IP<span class="p">&amp;</span>rdquo<span class="p">;</span> -m tcp <span class="p">&amp;</span>ndash<span class="p">;</span>dport <span class="m">80</span> -j KUBE-SVC-LFMD53S3EZEAOUSJ&lt;/p&gt;

&lt;p&gt;-A KUBE-SVC-LFMD53S3EZEAOUSJ -m comment <span class="p">&amp;</span>ndash<span class="p">;</span>comment <span class="p">&amp;</span>ldquo<span class="p">;</span>sock-shop/front-end:<span class="p">&amp;</span>rdquo<span class="p">;</span> -j KUBE-SEP-SM6TGF2R62ADFGQA&lt;/p&gt;

&lt;p&gt;-A KUBE-SEP-SM6TGF2R62ADFGQA -s 10.244.2.5/32 -m comment <span class="p">&amp;</span>ndash<span class="p">;</span>comment <span class="p">&amp;</span>ldquo<span class="p">;</span>sock-shop/front-end:<span class="p">&amp;</span>rdquo<span class="p">;</span> -j KUBE-MARK-MASQ
-A KUBE-SEP-SM6TGF2R62ADFGQA -p tcp -m comment <span class="p">&amp;</span>ndash<span class="p">;</span>comment <span class="p">&amp;</span>ldquo<span class="p">;</span>sock-shop/front-end:<span class="p">&amp;</span>rdquo<span class="p">;</span> -m tcp -j DNAT <span class="p">&amp;</span>ndash<span class="p">;</span>to-destination 10.244.2.5:8079</code></pre></div>
èªæ˜å¦‚ä½ ï¼Œä¸€å®šå·²ç»çœ‹æ˜ç™½äº†å§ã€‚</p>

<p>è¦æ˜¯è¿˜ä¸æ˜ç™½ï¼Œçœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼šæºåœ°å€å®¡è®¡ï¼š<a href="https://ieevee.com/tech/2017/09/18/k8s-svc-src.html">è¿½è¸ª kubernetees æœåŠ¡çš„SNAT</a> ã€‚</p>

<p>ä¸è¿‡kube-proxyçš„iptablesæœ‰ä¸ªç¼ºé™·ï¼Œå³å½“podæ•…éšœæ—¶æ— æ³•è‡ªåŠ¨é‡è¯•ï¼Œéœ€è¦ä¾èµ–readiness probesï¼Œä¸»è¦æ€æƒ³å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ¢æµ‹å®¹å™¨ï¼Œå½“æ£€æµ‹åˆ°åç«¯podæŒ‚äº†çš„æ—¶å€™ï¼Œæ›´æ–°iptablesã€‚</p>

<p>åœ¨ç”¨NodePortçš„æ—¶å€™ï¼Œç»å¸¸ä¼šæœ‰äººé—®ä¸€ä¸ªé—®é¢˜ï¼ŒNodePortæŒ‡å®šçš„ç«¯å£(30000+)ï¼Œè€Œclientå»ºç«‹tcpè¿æ¥æ—¶ï¼Œæœ¬åœ°ç«¯å£æ˜¯æ“ä½œç³»ç»Ÿéšæœºé€‰å®šçš„(30000+)ï¼Œå¦‚ä½•é˜²æ­¢äº§ç”Ÿå†²çªå‘¢ï¼Ÿ</p>

<p>è§£å†³åŠæ³•æ˜¯kube-proxyè¿›ç¨‹ä¼šå»èµ·ä¸€ä¸ªtcp listen socketï¼Œç›‘å¬ç«¯å£å·å°±æ˜¯NodePortã€‚å¯ä»¥æŠŠè¿™ä¸ªsocketç†è§£ä¸ºâ€œå ä½ç¬¦â€ï¼Œç›®çš„æ˜¯ä¸ºäº†è®©æ“ä½œç³»ç»Ÿè·³å¼€è¯¥ç«¯å£ã€‚</p>

<p>è½¬è½½è‡ª<a href="https://ieevee.com/tech/2017/01/20/k8s-service.html#kube-proxy">è°ˆè°ˆkubernetsçš„serviceç»„ä»¶çš„Virtual IP</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[éªŒè¯kubernetesçš„podå®‰å…¨ç­–ç•¥]]></title>
    <link href="http://liyongxin.github.io/blog/2019/03/18/yan-zheng-kubernetesde-podan-quan-ce-lue/"/>
    <updated>2019-03-18T14:19:02+08:00</updated>
    <id>http://liyongxin.github.io/blog/2019/03/18/yan-zheng-kubernetesde-podan-quan-ce-lue</id>
    <content type="html"><![CDATA[

<p>æœ€è¿‘æœ‰å®¢æˆ·æå‡ºéœ€è¦å¯¹ä¸šåŠ¡é›†ç¾¤çš„podåšå®‰å…¨é™åˆ¶ï¼Œä¸å…è®¸ä½¿ç”¨podæ‹¥æœ‰privilegedçš„æƒé™ï¼Œç ”ç©¶ä¸€ç•ªï¼Œåˆšå¥½k8sçš„<a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">Pod Security Policies</a>å¯ä»¥å®ç°è¯¥éœ€æ±‚ã€‚</p>

<h2>ä»€ä¹ˆæ˜¯podå®‰å…¨ç­–ç•¥</h2>

<p>Pod Security Policy(ç®€ç§°psp)æ˜¯é›†ç¾¤çº§åˆ«çš„èµ„æºï¼Œè¯¥èµ„æºæ§åˆ¶podçš„specä¸­å®‰å…¨ç›¸å…³çš„æ–¹é¢ï¼Œå…·ä½“çš„æ–¹é¢å‚è€ƒä¸‹è¡¨ï¼š</p>

<table>
<thead>
<tr>
<th style="text-align:center;">       Control Aspect                  </th>
<th style="text-align:center;">       Field Names     </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;"> Running of privileged containers      </td>
<td style="text-align:center;"> <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#privileged">privileged</a>   </td>
</tr>
<tr>
<td style="text-align:center;"> Usage of host namespaces              </td>
<td style="text-align:center;">   <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#host-namespaces">hostPID, hostIPC</a>  </td>
</tr>
<tr>
<td style="text-align:center;"> Usage of host networking and ports    </td>
<td style="text-align:center;">    <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#host-namespaces">hostNetwork, hostPorts</a>  </td>
</tr>
<tr>
<td style="text-align:center;"> Usage of volume types                 </td>
<td style="text-align:center;"> <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#volumes-and-file-systems">volumes</a>   </td>
</tr>
<tr>
<td style="text-align:center;"> Usage of the host filesystem          </td>
<td style="text-align:center;">  <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#volumes-and-file-systems">allowedHostPaths</a>  </td>
</tr>
<tr>
<td style="text-align:center;"> White list of Flexvolume drivers      </td>
<td style="text-align:center;">   <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#flexvolume-drivers">allowedFlexVolumes</a>  </td>
</tr>
<tr>
<td style="text-align:center;"> Allocating an FSGroup that owns the podâ€™s volumes           </td>
<td style="text-align:center;"> <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#volumes-and-file-systems">fsGroup</a>   </td>
</tr>
<tr>
<td style="text-align:center;"> Requiring the use of a read only root file system             </td>
<td style="text-align:center;">   <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#volumes-and-file-systems">readOnlyRootFilesystem</a>  </td>
</tr>
<tr>
<td style="text-align:center;"> The user and group IDs of the container       </td>
<td style="text-align:center;">    <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#users-and-groups">runAsUser, runAsGroup, supplementalGroups</a>  </td>
</tr>
<tr>
<td style="text-align:center;"> The SELinux context of the container                      </td>
<td style="text-align:center;"> <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#selinux">seLinux</a>   </td>
</tr>
</tbody>
</table>


<!--more-->


<h2>å¦‚ä½•å¼€å¯Pod Security Policy</h2>

<ul>
<li><strong>Enable API extensions</strong></li>
</ul>


<p>For Kubernetes &lt; 1.6.0, the API Server must enable the extensions/v1beta1/podsecuritypolicy API extensions group (&ndash;runtime-config=extensions/v1beta1/podsecuritypolicy=true).</p>

<ul>
<li><strong>Enable PodSecurityPolicy admission control policy</strong></li>
</ul>


<p>The following parameter needs to be added to the API server startup argument: â€“admission-control=PodSecurityPolicy</p>

<p>é»˜è®¤pspæ˜¯ä¸å¼€å¯çš„ï¼Œè‹¥è¦å¼€å¯ï¼Œéœ€è¦é…ç½®ä¸Šè¿°apiserverå¯åŠ¨å‚æ•°ï¼Œé»˜è®¤çš„apiserverçš„yamlæ–‡ä»¶ä¸º<code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="p">&amp;</span>hellip<span class="p">;</span>
spec:
  containers:
  - <span class="nb">command</span>:
    - kube-apiserver
    - <span class="p">&amp;</span>ndash<span class="p">;</span>authorization-mode<span class="o">=</span>Node,RBAC
    - <span class="p">&amp;</span>ndash<span class="p">;</span><span class="nb">enable</span>-admission-plugins<span class="o">=</span>Initializers,NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,ResourceQuota,PodSecurityPolicy
    - <span class="p">&amp;</span>ndash<span class="p">;</span>runtime-config<span class="o">=</span>extensions/v1beta1/podsecuritypolicy<span class="o">=</span><span class="nb">true</span>
    <span class="p">&amp;</span>hellip<span class="p">;</span></code></pre></div></p>

<h2>é…ç½®é»˜è®¤çš„psp</h2>

<p>ç”±äºå·²æœ‰æ‰“å¼€äº†podåˆ›å»ºçš„å®‰å…¨ç­–ç•¥,ä½†æ­¤æ—¶è¿˜æœªåˆ›å»ºä»»ä½•çš„policyï¼Œæ‰€ä»¥ä»»ä½•podéƒ½æ— æ³•è¢«åˆ›å»ºï¼Œæ­¤æ—¶å¦‚æœå°è¯•å»åˆ›å»ºä¸€ä¸ªpodï¼Œä¼šå‘ç°podæ— æ³•è¿›è¡Œè°ƒåº¦ï¼Œ
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@build-master apiserver<span class="o">]</span><span class="c"># kubectl run &amp;ndash;image=nginx yxli</span>
deployment.apps/yxli created
<span class="o">[</span>root@build-master apiserver<span class="o">]</span><span class="c"># kubectl get deploy yxli</span>
NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
yxli      <span class="m">1</span>         <span class="m">0</span>         <span class="m">0</span>            <span class="m">0</span>           4m</code></pre></div>
æŸ¥çœ‹controllerçš„æ—¥å¿—ä¼šå‘ç°æŠ¥é”™forbidden: no providers available to validate pod request
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@build-master ~<span class="o">]</span><span class="c"># kubectl logs &amp;ndash;tail=10 -f kube-controller-manager-build-master -n kube-system</span>
E0318 03:01:17.321184       <span class="m">1</span> replica_set.go:450<span class="o">]</span> Sync <span class="p">&amp;</span>ldquo<span class="p">;</span>default/yxli-6978dddc9d<span class="p">&amp;</span>rdquo<span class="p">;</span> failed with pods <span class="p">&amp;</span>ldquo<span class="p">;</span>yxli-6978dddc9d-<span class="p">&amp;</span>rdquo<span class="p">;</span> is forbidden: no providers available to validate pod request
I0318 03:01:17.321302       <span class="m">1</span> event.go:221<span class="o">]</span> Event<span class="o">(</span>v1.ObjectReference<span class="o">{</span>Kind:<span class="p">&amp;</span>ldquo<span class="p">;</span>ReplicaSet<span class="p">&amp;</span>rdquo<span class="p">;</span>, Namespace:<span class="p">&amp;</span>ldquo<span class="p">;</span>default<span class="p">&amp;</span>rdquo<span class="p">;</span>, Name:<span class="p">&amp;</span>ldquo<span class="p">;</span>yxli-6978dddc9d<span class="p">&amp;</span>rdquo<span class="p">;</span>, UID:<span class="p">&amp;</span>ldquo<span class="p">;</span>0d11050f-492a-11e9-8ef0-00163e004fd2<span class="p">&amp;</span>rdquo<span class="p">;</span>, APIVersion:<span class="p">&amp;</span>ldquo<span class="p">;</span>apps/v1<span class="p">&amp;</span>rdquo<span class="p">;</span>, ResourceVersion:<span class="p">&amp;</span>ldquo<span class="p">;</span>764927<span class="p">&amp;</span>rdquo<span class="p">;</span>, FieldPath:<span class="p">&amp;</span>ldquo<span class="p">;&amp;</span>rdquo<span class="p">;</span><span class="o">})</span>: <span class="nb">type</span>: <span class="p">&amp;</span>lsquo<span class="p">;</span>Warning<span class="p">&amp;</span>rsquo<span class="p">;</span> reason: <span class="p">&amp;</span>lsquo<span class="p">;</span>FailedCreate<span class="p">&amp;</span>rsquo<span class="p">;</span> Error creating: pods <span class="p">&amp;</span>ldquo<span class="p">;</span>yxli-6978dddc9d-<span class="p">&amp;</span>rdquo<span class="p">;</span> is forbidden: no providers available to validate pod request
E0318 03:01:37.807060       <span class="m">1</span> replica_set.go:450<span class="o">]</span> Sync <span class="p">&amp;</span>ldquo<span class="p">;</span>default/yxli-6978dddc9d<span class="p">&amp;</span>rdquo<span class="p">;</span> failed with pods <span class="p">&amp;</span>ldquo<span class="p">;</span>yxli-6978dddc9d-<span class="p">&amp;</span>rdquo<span class="p">;</span> is forbidden: no providers available to validate pod request
I0318 03:01:37.807046       <span class="m">1</span> event.go:221<span class="o">]</span> Event<span class="o">(</span>v1.ObjectReference<span class="o">{</span>Kind:<span class="p">&amp;</span>ldquo<span class="p">;</span>ReplicaSet<span class="p">&amp;</span>rdquo<span class="p">;</span>, Namespace:<span class="p">&amp;</span>ldquo<span class="p">;</span>default<span class="p">&amp;</span>rdquo<span class="p">;</span>, Name:<span class="p">&amp;</span>ldquo<span class="p">;</span>yxli-6978dddc9d<span class="p">&amp;</span>rdquo<span class="p">;</span>, UID:<span class="p">&amp;</span>ldquo<span class="p">;</span>0d11050f-492a-11e9-8ef0-00163e004fd2<span class="p">&amp;</span>rdquo<span class="p">;</span>, APIVersion:<span class="p">&amp;</span>ldquo<span class="p">;</span>apps/v1<span class="p">&amp;</span>rdquo<span class="p">;</span>, ResourceVersion:<span class="p">&amp;</span>ldquo<span class="p">;</span>764927<span class="p">&amp;</span>rdquo<span class="p">;</span>, FieldPath:<span class="p">&amp;</span>ldquo<span class="p">;&amp;</span>rdquo<span class="p">;</span><span class="o">})</span>: <span class="nb">type</span>: <span class="p">&amp;</span>lsquo<span class="p">;</span>Warning<span class="p">&amp;</span>rsquo<span class="p">;</span> reason: <span class="p">&amp;</span>lsquo<span class="p">;</span>FailedCreate<span class="p">&amp;</span>rsquo<span class="p">;</span> Error creating: pods <span class="p">&amp;</span>ldquo<span class="p">;</span>yxli-6978dddc9d-<span class="p">&amp;</span>rdquo<span class="p">;</span> is forbidden: no providers available to validate pod request
E0318 03:02:18.773092       <span class="m">1</span> replica_set.go:450<span class="o">]</span> Sync <span class="p">&amp;</span>ldquo<span class="p">;</span>default/yxli-6978dddc9d<span class="p">&amp;</span>rdquo<span class="p">;</span> failed with pods <span class="p">&amp;</span>ldquo<span class="p">;</span>yxli-6978dddc9d-<span class="p">&amp;</span>rdquo<span class="p">;</span> is forbidden: no providers available to validate pod request</code></pre></div></p>

<p>è€Œç”±äºæˆ‘ä»¬ä¿®æ”¹äº†apiserverçš„å‚æ•°ï¼Œpodå—kubeletç®¡ç†ï¼Œè‡ªåŠ¨è§¦å‘äº†é‡å»ºï¼Œæ­¤æ—¶apiserverçš„podä¹Ÿæ˜¯å› ä¸ºç¼ºå°‘æƒé™æ²¡æ³•åˆ›å»ºå‡ºæ¥
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@build-master apiserver<span class="o">]</span><span class="c"># journalctl -fu kubelet</span>
<span class="p">&amp;</span>ndash<span class="p">;</span> Logs begin at Tue 2019-03-12 20:33:59 CST. <span class="p">&amp;</span>ndash<span class="p">;</span>
Mar <span class="m">18</span> 11:25:29 build-master kubelet<span class="o">[</span>4013<span class="o">]</span>: E0318 11:25:29.016416    <span class="m">4013</span> kubelet.go:1594<span class="o">]</span> Failed creating a mirror pod <span class="k">for</span> <span class="p">&amp;</span>ldquo<span class="p">;</span>kube-apiserver-build-master_kube-system<span class="o">(</span>77a7d13c654e7233306d4e2948aaaa78<span class="o">)</span><span class="p">&amp;</span>rdquo<span class="p">;</span>: pods <span class="p">&amp;</span>ldquo<span class="p">;</span>kube-apiserver-build-master<span class="p">&amp;</span>rdquo<span class="p">;</span> is forbidden: no providers available to validate pod request
Mar <span class="m">18</span> 11:25:30 build-master kubelet<span class="o">[</span>4013<span class="o">]</span>: W0318 11:25:30.113587    <span class="m">4013</span> kubelet.go:1579<span class="o">]</span> Deleting mirror pod <span class="p">&amp;</span>ldquo<span class="p">;</span>kube-apiserver-build-master_kube-system<span class="o">(</span>e48d84cd-46f0-11e9-8ef0-00163e004fd2<span class="o">)</span><span class="p">&amp;</span>rdquo<span class="p">;</span> because it is outdated
Mar <span class="m">18</span> 11:25:30 build-master kubelet<span class="o">[</span>4013<span class="o">]</span>: E0318 11:25:30.117242    <span class="m">4013</span> kubelet.go:1594<span class="o">]</span> Failed creating a mirror pod <span class="k">for</span> <span class="p">&amp;</span>ldquo<span class="p">;</span>kube-apiserver-build-master_kube-system<span class="o">(</span>77a7d13c654e7233306d4e2948aaaa78<span class="o">)</span><span class="p">&amp;</span>rdquo<span class="p">;</span>: pods <span class="p">&amp;</span>ldquo<span class="p">;</span>kube-apiserver-build-master<span class="p">&amp;</span>rdquo<span class="p">;</span> is forbidden: no providers available to validate pod request</code></pre></div></p>

<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªpolicyï¼Œä¸ºæˆ‘ä»¬éœ€è¦çš„å—kubeletç®¡ç†çš„é™æ€podä»¥åŠkube-systemå‘½åç©ºé—´ä¸‹çš„podæä¾›æƒé™ï¼Œå¦åˆ™podä¸€æ—¦å‘ç”Ÿé‡å»ºï¼Œéƒ½å°†å› ä¸ºç¼ºå°‘æƒé™å¯¼è‡´æ— æ³•æ­£å¸¸åˆ›å»ºå‡ºæ¥ã€‚</p>

<p>é¦–å…ˆæ–°å»ºæ–‡ä»¶ privileged.policy.yamlï¼Œæƒé™ä¸å—é™åˆ¶ï¼Œ
<div class="highlight"><pre><code class="language-bash" data-lang="bash">apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: privileged
spec:
  allowedCapabilities:
  - <span class="p">&amp;</span>lsquo<span class="p">;</span>&lt;em&gt;<span class="p">&amp;</span>rsquo<span class="p">;</span>
  allowPrivilegeEscalation: <span class="nb">true</span>
<span class="nb">  </span>fsGroup:
    rule: <span class="p">&amp;</span>lsquo<span class="p">;</span>RunAsAny<span class="p">&amp;</span>rsquo<span class="p">;</span>
  hostIPC: <span class="nb">true</span>
<span class="nb">  </span>hostNetwork: <span class="nb">true</span>
<span class="nb">  </span>hostPID: <span class="nb">true</span>
<span class="nb">  </span>hostPorts:
  - min: 0
    max: 65535
  privileged: <span class="nb">true</span>
<span class="nb">  </span>readOnlyRootFilesystem: <span class="nb">false</span>
<span class="nb">  </span>runAsUser:
    rule: <span class="p">&amp;</span>lsquo<span class="p">;</span>RunAsAny<span class="p">&amp;</span>rsquo<span class="p">;</span>
  seLinux:
    rule: <span class="p">&amp;</span>lsquo<span class="p">;</span>RunAsAny<span class="p">&amp;</span>rsquo<span class="p">;</span>
  supplementalGroups:
    rule: <span class="p">&amp;</span>lsquo<span class="p">;</span>RunAsAny<span class="p">&amp;</span>rsquo<span class="p">;</span>
  volumes:
  - <span class="p">&amp;</span>lsquo<span class="p">;</span>&lt;/em&gt;<span class="p">&amp;</span>rsquo<span class="p">;</span></code></pre></div></p>

<p>åˆ›å»ºå¹¶æŸ¥çœ‹è¯¥policy
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@build-master apiserver<span class="o">]</span><span class="c"># kubectl create -f privileged.policy.yaml</span>
podsecuritypolicy.policy/privileged created
<span class="o">[</span>root@build-master apiserver<span class="o">]</span><span class="c"># kubectl get psp</span>
NAME         PRIV      CAPS      SELINUX    RUNASUSER   FSGROUP    SUPGROUP   READONLYROOTFS   VOLUMES
privileged   <span class="nb">true</span>      *         RunAsAny   RunAsAny    RunAsAny   RunAsAny   <span class="nb">false</span>            *</code></pre></div></p>

<p>ç„¶åè¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªclusterroleï¼Œå¹¶ä¸”èµ‹äºˆè¯¥roleå¯¹ä¸Šè¿°pspå¯¹ä½¿ç”¨æƒ
<div class="highlight"><pre><code class="language-bash" data-lang="bash">&lt;/p&gt;

&lt;h1&gt;Cluster role which grants access to the privileged pod security policy&lt;/h1&gt;

&lt;p&gt;apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: privileged-psp
rules:
- apiGroups:
  - policy
  resourceNames:
  - privileged
  resources:
  - podsecuritypolicies
  verbs:
  - use</code></pre></div>
ç„¶åæŠŠclusterroleèµ‹äºˆserviceaccountæˆ–è€…å¯¹åº”çš„userã€groupï¼Œé’ˆå¯¹kube-systemå‘½åç©ºé—´ä¸‹çš„podæ¥è¯´ï¼Œéƒ½ä½¿ç”¨äº†kube-systemä¸‹çš„serviceaccountæˆ–è€…ç”±kubeletç®¡ç†ï¼Œkubeletæ˜¯ä½¿ç”¨system:nodesè¿™ä¸ªç»„æ¥ç®¡ç†çš„podï¼Œæ‰€ä»¥åªéœ€è¦åšå¦‚ä¸‹bindingå³å¯ä¸ºkube-systemä¸‹çš„æ‰€æœ‰podæä¾›æƒé™ï¼Œ
<div class="highlight"><pre><code class="language-bash" data-lang="bash">apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kube-system-psp
  namespace: kube-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: privileged-psp
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:nodes
  namespace: kube-system
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:serviceaccounts:kube-system</code></pre></div></p>

<p>éƒ½åˆ›å»ºå¥½ä¹‹åï¼ŒæŸ¥çœ‹kube-systemä¸‹çš„podï¼Œå‘ç°apiserverå·²ç»åˆ›å»ºæˆåŠŸ
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@build-master apiserver<span class="o">]</span><span class="c"># kubectl get po -n kube-system</span>
NAME                                   READY     STATUS    RESTARTS   AGE
coredns-68f5b48ccb-9hjvr               1/1       Running   <span class="m">0</span>          5d
coredns-68f5b48ccb-qrjnr               1/1       Running   <span class="m">0</span>          5d
etcd-build-master                      1/1       Running   <span class="m">0</span>          5d
kube-apiserver-build-master            1/1       Running   <span class="m">0</span>          18s</code></pre></div></p>

<blockquote><p>ä¸Šé¢çš„bindingåªæ˜¯ä¸ºkube-systemç©ºé—´èµ‹äºˆäº†æƒé™ï¼Œè‹¥æƒ³è¦ä¸ºåˆ«çš„å‘½åç©ºé—´èµ‹äºˆæƒé™ï¼Œå¯ä»¥ä½¿ç”¨ClusterRoleBindingçš„æ–¹å¼ä¸ºå¤šä¸ªnamespaceç»‘å®šprivileged-pspçš„clusterroleï¼Œæˆ–è€…åƒå¦‚ä¸‹æ–¹å¼ï¼Œä¸ºæ‰€æœ‰åˆæ³•çš„serviceaccountså’Œuserç»‘å®šæƒé™ï¼Œå½“ç„¶å‰ææ˜¯podä½¿ç”¨äº†namespaceä¸‹çš„serviceAccount
<div class="highlight"><pre><code class="language-bash" data-lang="bash">&lt;/p&gt;

&lt;h1&gt;Authorize all service accounts in a namespace:&lt;/h1&gt;

&lt;ul&gt;
&lt;li&gt;kind: Group
apiGroup: rbac.authorization.k8s.io
name: system:serviceaccounts

&lt;h1&gt;Or equivalently, all authenticated users in a namespace:&lt;/h1&gt;&lt;/li&gt;
&lt;li&gt;kind: Group
apiGroup: rbac.authorization.k8s.io
name: system:authenticated</code></pre></div></li>
</ul>
</blockquote>

<h2>éªŒè¯pspçš„privilegedé™åˆ¶</h2>

<p>è¯¥ç« èŠ‚ä¼šåˆ›å»ºä¸€ä¸ªåä¸ºpsp-namespaceçš„namespaceåšæµ‹è¯•ï¼Œæ¥éªŒè¯pspä¸­å¯¹privilegedçš„podçš„é™åˆ¶
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@build-master apiserver<span class="o">]</span><span class="c"># kubectl create namespace psp-example</span>
namespace/psp-example created
<span class="o">[</span>root@build-master apiserver<span class="o">]</span><span class="c"># kubectl create serviceaccount fake-user -n psp-example</span>
serviceaccount/fake-user created
<span class="o">[</span>root@build-master apiserver<span class="o">]</span><span class="c"># kubectl run &amp;ndash;image=nginx psp-pod-nginx-1 -n psp-example &amp;ndash;serviceaccount=fake-user</span>
deployment.apps/psp-pod-nginx-1 created
<span class="o">[</span>root@build-master apiserver<span class="o">]</span><span class="c"># kubectl get po -n psp-example</span>
No resources found.
<span class="o">[</span>root@build-master apiserver<span class="o">]</span><span class="c"># kubectl get deploy -n psp-example</span>
NAME              DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
psp-pod-nginx-1   <span class="m">1</span>         <span class="m">0</span>         <span class="m">0</span>            <span class="m">0</span>           23s</code></pre></div></p>

<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œæ–°çš„psp-exampleå‘½åç©ºé—´ç”±äºæ²¡æœ‰ä»»ä½•æƒé™ï¼Œæ‰€ä»¥æ— æ³•åˆ›å»ºæ–°podï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªpolicyå¹¶ç»™psp-exampleåšauthorizeï¼Œä½†æ˜¯policyä¸­ä¼šé™åˆ¶æ— æ³•åˆ›å»ºprivilegedçš„pod
<div class="highlight"><pre><code class="language-bash" data-lang="bash">apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: example
spec:
  privileged: <span class="nb">false</span>  <span class="c"># Don&amp;rsquo;t allow privileged pods!</span>
  <span class="c"># The rest fills in some required fields.</span>
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  runAsUser:
    rule: RunAsAny
  fsGroup:
    rule: RunAsAny
  volumes:
  - <span class="p">&amp;</span>lsquo<span class="p">;</span>*<span class="p">&amp;</span>rsquo<span class="p">;</span></code></pre></div></p>

<p> ç„¶ååˆ›å»ºroleå’Œrolebindingï¼Œå¹¶éªŒè¯fake-useræ˜¯å¦æœ‰æƒé™ä½¿ç”¨exampleçš„policy
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@build-master psp-example<span class="o">]</span><span class="c"># kubectl -n psp-example create role psp:unprivileged &amp;ndash;verb=use &amp;ndash;resource=podsecuritypolicy &amp;ndash;resource-name=example</span>
role.rbac.authorization.k8s.io/psp:unprivileged created
<span class="o">[</span>root@build-master psp-example<span class="o">]</span><span class="c"># kubectl -n psp-example create rolebinding fake-user:psp:unprivileged &amp;ndash;role=psp:unprivileged &amp;ndash;serviceaccount=psp-example:fake-user</span>
rolebinding.rbac.authorization.k8s.io/fake-user:psp:unprivileged created
<span class="o">[</span>root@build-master psp-example<span class="o">]</span><span class="c">#  kubectl &amp;ndash;as=system:serviceaccount:psp-example:fake-user -n psp-example auth can-i use podsecuritypolicy/example</span>
yes</code></pre></div></p>

<p>ç­‰å¾…ç‰‡åˆ»ï¼Œå†æ¬¡æŸ¥çœ‹åˆšæ‰åˆ›å»ºçš„deployï¼Œå‘ç°å·²ç»è°ƒåº¦æˆåŠŸ
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@build-master psp-example<span class="o">]</span><span class="c"># kubectl get deploy -n psp-example psp-pod-nginx-1</span>
NAME              DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
psp-pod-nginx-1   <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>            <span class="m">1</span>           22m</code></pre></div></p>

<p>æ­¤æ—¶æˆ‘ä»¬å°è¯•åœ¨psp-exampleä¸‹åˆ›å»ºä¸€ä¸ªprivilegedçš„ç‰¹æƒå®¹å™¨ï¼Œ
<div class="highlight"><pre><code class="language-bash" data-lang="bash">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    run: psp-pod-nginx-privileged
  name: psp-pod-nginx-privileged
  namespace: psp-example
spec:
  selector:
    matchLabels:
      run: psp-pod-nginx-privileged
  template:
    metadata:
      labels:
        run: psp-pod-nginx-privileged
    spec:
      containers:
      - image: nginx
        imagePullPolicy: Always
        name: psp-pod-nginx-privileged
      securityContext:
        privileged: <span class="nb">true</span>
<span class="nb">      </span>serviceAccount: fake-user</code></pre></div>
åˆ›å»ºå¹¶æŸ¥çœ‹ç»“æœ
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@build-master psp-example<span class="o">]</span><span class="c"># kubectl create -f privileged-pod.yaml</span>
deployment.extensions/psp-pod-nginx-privileged created
<span class="o">[</span>root@build-master psp-example<span class="o">]</span><span class="c"># kubectl get deploy -n psp-example psp-pod-nginx-privileged</span>
psp-pod-nginx-privileged   <span class="m">1</span>         <span class="m">0</span>         <span class="m">0</span>            <span class="m">0</span>           24s
<span class="o">[</span>root@build-master ~<span class="o">]</span><span class="c"># kubectl logs &amp;ndash;tail=1 -f kube-controller-manager-build-master -n kube-system</span>
I0318 04:32:42.777200       <span class="m">1</span> event.go:221<span class="o">]</span> Event<span class="o">(</span>v1.ObjectReference<span class="o">{</span>Kind:<span class="p">&amp;</span>ldquo<span class="p">;</span>ReplicaSet<span class="p">&amp;</span>rdquo<span class="p">;</span>, Namespace:<span class="p">&amp;</span>ldquo<span class="p">;</span>psp-example<span class="p">&amp;</span>rdquo<span class="p">;</span>, Name:<span class="p">&amp;</span>ldquo<span class="p">;</span>psp-pod-nginx-privileged-d7f8dbd75<span class="p">&amp;</span>rdquo<span class="p">;</span>, UID:<span class="p">&amp;</span>ldquo<span class="p">;</span>c66fb10f-4936-11e9-9c58-00163e004fd2<span class="p">&amp;</span>rdquo<span class="p">;</span>, APIVersion:<span class="p">&amp;</span>ldquo<span class="p">;</span>apps/v1<span class="p">&amp;</span>rdquo<span class="p">;</span>, ResourceVersion:<span class="p">&amp;</span>ldquo<span class="p">;</span>773292<span class="p">&amp;</span>rdquo<span class="p">;</span>, FieldPath:<span class="p">&amp;</span>ldquo<span class="p">;&amp;</span>rdquo<span class="p">;</span><span class="o">})</span>: <span class="nb">type</span>: <span class="p">&amp;</span>lsquo<span class="p">;</span>Warning<span class="p">&amp;</span>rsquo<span class="p">;</span> reason: <span class="p">&amp;</span>lsquo<span class="p">;</span>FailedCreate<span class="p">&amp;</span>rsquo<span class="p">;</span> Error creating: pods <span class="p">&amp;</span>ldquo<span class="p">;</span>psp-pod-nginx-privileged-d7f8dbd75-<span class="p">&amp;</span>rdquo<span class="p">;</span> is forbidden: unable to validate against any pod security policy: <span class="o">[</span>spec.containers<span class="o">[</span>0<span class="o">]</span>.securityContext.privileged: Invalid value: <span class="nb">true</span>: Privileged containers are not allowed<span class="o">]</span></code></pre></div>
æŸ¥çœ‹controller-managerçš„æ—¥å¿—ï¼Œå‘ç°Privileged containers are not allowed</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[somethings about kubernetes]]></title>
    <link href="http://liyongxin.github.io/blog/2019/02/28/k8sxiao-zhi-shi/"/>
    <updated>2019-02-28T11:12:56+08:00</updated>
    <id>http://liyongxin.github.io/blog/2019/02/28/k8sxiao-zhi-shi</id>
    <content type="html"><![CDATA[<ul>
<li><p>k8sé»˜è®¤é©±é€è®¾ç½®
<div class="highlight"><pre><code class="language-bash" data-lang="bash">// DefaultEvictionHard includes default options <span class="k">for</span> hard eviction.
var <span class="nv">DefaultEvictionHard</span> <span class="o">=</span> map<span class="o">[</span>string<span class="o">]</span>string<span class="o">{</span>
      <span class="p">&amp;</span>ldquo<span class="p">;</span>memory.available<span class="p">&amp;</span>rdquo<span class="p">;</span>:  <span class="p">&amp;</span>ldquo<span class="p">;</span>100Mi<span class="p">&amp;</span>rdquo<span class="p">;</span>,
      <span class="p">&amp;</span>ldquo<span class="p">;</span>nodefs.available<span class="p">&amp;</span>rdquo<span class="p">;</span>:  <span class="p">&amp;</span>ldquo<span class="p">;</span>10%<span class="p">&amp;</span>rdquo<span class="p">;</span>,
      <span class="p">&amp;</span>ldquo<span class="p">;</span>nodefs.inodesFree<span class="p">&amp;</span>rdquo<span class="p">;</span>: <span class="p">&amp;</span>ldquo<span class="p">;</span>5%<span class="p">&amp;</span>rdquo<span class="p">;</span>,
      <span class="p">&amp;</span>ldquo<span class="p">;</span>imagefs.available<span class="p">&amp;</span>rdquo<span class="p">;</span>: <span class="p">&amp;</span>ldquo<span class="p">;</span>15%<span class="p">&amp;</span>rdquo<span class="p">;</span>,
<span class="o">}</span></code></pre></div></p></li>
<li><p>kubernetes æ»šåŠ¨å‡çº§
<div class="highlight"><pre><code class="language-bash" data-lang="bash">&lt;/p&gt;

&lt;h1&gt;run <span class="nb">test </span>deploy&lt;/h1&gt;

<span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c"># kubectl run &amp;ndash;image=nginx &amp;ndash;port=80 &amp;ndash;replicas=2 yxli-nginx</span>

&lt;h1&gt;scale replica&lt;/h1&gt;

<span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c"># kubectl scale &amp;ndash;replicas=1 deploy/yxli-nginx</span>
<span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c"># kubectl get deploy</span>
NAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
busybox      <span class="m">2</span>         <span class="m">2</span>         <span class="m">2</span>            <span class="m">2</span>           39d
busybox1     <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>            <span class="m">1</span>           39d
yxli-nginx   <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>            <span class="m">1</span>           2h

&lt;h1&gt;update image&lt;/h1&gt;

<span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c"># kubectl set image  deploy/yxli-nginx yxli-nginx=nginx:alpine</span>

&lt;h1&gt;æŸ¥çœ‹å‡çº§å†å²&lt;/h1&gt;

<span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c"># kubectl rollout history deploy/yxli-nginx</span>
deployments <span class="p">&amp;</span>ldquo<span class="p">;</span>yxli-nginx<span class="p">&amp;</span>rdquo<span class="p">;</span>
REVISION  CHANGE-CAUSE
<span class="m">1</span>         &lt;none&gt;
<span class="m">2</span>         &lt;none&gt;

&lt;h1&gt;å›é¡¾è‡³ä¸Šæ¬¡ç‰ˆæœ¬&lt;/h1&gt;

<span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c"># kubectl rollout undo deploy/yxli-nginx</span>
<span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c"># kubectl rollout history deploy/yxli-nginx</span>
deployments <span class="p">&amp;</span>ldquo<span class="p">;</span>yxli-nginx<span class="p">&amp;</span>rdquo<span class="p">;</span>
REVISION  CHANGE-CAUSE
<span class="m">2</span>         &lt;none&gt;
<span class="m">3</span>         &lt;none&gt;

&lt;h1&gt;å›æ»šè‡³æŒ‡å®šç‰ˆæœ¬&lt;/h1&gt;

&lt;p&gt;<span class="o">[</span>root@k8s-master ~<span class="o">]</span><span class="c"># kubectl rolloutundo deployment/lykops-dpm &amp;ndash;to-revision=2</span></code></pre></div></p></li>
</ul>


<!--more-->


<ul>
<li>æŸ¥çœ‹dockerä½¿ç”¨çš„cpuæ ¸å¿ƒæ•°
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@yxli-onebox docker<span class="o">]</span><span class="c"># pwd</span>
/sys/fs/cgroup/cpuset/docker
<span class="o">[</span>root@yxli-onebox docker<span class="o">]</span><span class="c"># cat cpuset.cpus</span>
0-7</code></pre></div></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[kubeletçš„è®¤è¯]]></title>
    <link href="http://liyongxin.github.io/blog/2018/08/25/kubeletde-ren-zheng/"/>
    <updated>2018-08-25T18:17:17+08:00</updated>
    <id>http://liyongxin.github.io/blog/2018/08/25/kubeletde-ren-zheng</id>
    <content type="html"><![CDATA[<p>ç ”ç©¶å®Œ<a href="../kuberneteszhong-de-ren-zheng-xiang-guan">kubectlçš„è®¤è¯ä¸æˆæƒ</a>ï¼Œä½¿ç”¨ç›¸åŒçš„æ–¹å¼å»æ‰¾kubeletçš„è®¿é—®ï¼Œ
é¦–å…ˆå®šä½é…ç½®æ–‡ä»¶<code>/etc/kubernetes/kubelet.conf</code>ï¼Œç„¶åç”¨ç›¸åŒçš„æ–¹å¼å¯¹<code>client-key-data</code>åšbase64è§£ç ï¼Œä¿å­˜ä¸ºkubelet.crtæ–‡ä»¶ã€‚</p>

<p>opensslæŸ¥çœ‹crtè¯ä¹¦ï¼Œ
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@k8s-master kubernetes<span class="o">]</span><span class="c"># openssl x509 -text -in kubelet.crt -noout</span>
Certificate:
    Data:
        Version: <span class="m">3</span> <span class="o">(</span>0x2<span class="o">)</span>
        Serial Number: <span class="m">8126553944389053218</span> <span class="o">(</span>0x70c751c18f5beb22<span class="o">)</span>
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: <span class="nv">CN</span><span class="o">=</span>kubernetes
        Validity
            Not Before: Aug <span class="m">20</span> 05:50:39 <span class="m">2018</span> GMT
            Not After : Aug <span class="m">20</span> 05:50:42 <span class="m">2019</span> GMT
        Subject: <span class="nv">O</span><span class="o">=</span>system:nodes, <span class="nv">CN</span><span class="o">=</span>system:node:k8s-master
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: <span class="o">(</span><span class="m">2048</span> bit<span class="o">)</span>
                Modulus:
                    00:9f:92:83:49:aa:cc:52:0e:de:bd:af:a6:fd:ef:
    <span class="p">&amp;</span>hellip<span class="p">;</span> <span class="p">&amp;</span>hellip<span class="p">;</span></code></pre></div></p>

<p>å¾—åˆ°æˆ‘ä»¬æœŸæœ›çš„å†…å®¹ï¼š
<div class="highlight"><pre><code class="language-bash" data-lang="bash">Subject: <span class="nv">O</span><span class="o">=</span>system:nodes, <span class="nv">CN</span><span class="o">=</span>system:node:k8s-master</code></pre></div></p>

<blockquote><p>å…³äºSubjectï¼Œåœ¨k8sä¸­å¯ä»¥ç†è§£ä¸ºè§’è‰²ç»‘å®šä¸»ä½“ï¼ŒRoleBindingæˆ–è€…ClusterRoleBindingå¯ä»¥å°†è§’è‰²ç»‘å®šåˆ°è§’è‰²ç»‘å®šä¸»ä½“ï¼ˆSubjectï¼‰ã€‚
è§’è‰²ç»‘å®šä¸»ä½“å¯ä»¥æ˜¯ç”¨æˆ·ç»„ï¼ˆGroupï¼‰ã€ç”¨æˆ·ï¼ˆUserï¼‰æˆ–è€…æœåŠ¡è´¦æˆ·ï¼ˆService Accountsï¼‰</p></blockquote>

<p>ç„¶åæˆ‘å°è¯•å»k8sä¸­æ‰¾åˆ°ä¸€äº›å…³äº<code>system:nodes</code>çš„RoleBindingsæˆ–è€…ClusterRoleBindings,
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root@k8s-master kubernetes<span class="o">]</span><span class="c"># for bd in &lt;code&gt;kubectl get clusterrolebindings |awk &#39;{print $1}&#39;&lt;/code&gt;; do echo $bd;kubectl get clusterrolebindings $bd -o yaml|grep &amp;lsquo;system:nodes&amp;rsquo;;done</span>
NAME
Error from server <span class="o">(</span>NotFound<span class="o">)</span>: clusterrolebindings.rbac.authorization.k8s.io <span class="p">&amp;</span>ldquo<span class="p">;</span>NAME<span class="p">&amp;</span>rdquo<span class="p">;</span> not found
cluster-admin
flannel
kubeadm:kubelet-bootstrap
kubeadm:node-autoapprove-bootstrap
kubeadm:node-autoapprove-certificate-rotation
  name: system:nodes
kubeadm:node-proxier
system:aws-cloud-provider
system:basic-user
<span class="p">&amp;</span>hellip<span class="p">;</span> <span class="p">&amp;</span>hellip<span class="p">;</span></code></pre></div></p>

<p>ç»“å±€æœ‰ç‚¹æ„å¤–ï¼Œé™¤äº†<code>kubeadm:node-autoapprove-certificate-rotation</code>å¤–ï¼Œæ²¡æœ‰æ‰¾åˆ°systemç›¸å…³çš„rolebindingsï¼Œæ˜¾ç„¶å’Œæˆ‘ä»¬çš„ç†è§£ä¸ä¸€æ ·ã€‚
å°è¯•å»æ‰¾<a href="https://github.com/rootsongjc/kubernetes-handbook/blob/master/guide/rbac.md">èµ„æ–™</a>ï¼Œå‘ç°äº†è¿™ä¹ˆä¸€æ®µ</p>

<p><img src="/images/rbac.png" alt="" /></p>

<p>Kubernetes 1.7å¼€å§‹, apiserverçš„å¯åŠ¨ä¸­é»˜è®¤å¢åŠ äº†<code>--authorization-mode=Node,RBAC</code>,ä¹Ÿå°±æ˜¯è¯´ï¼Œé™¤äº†RBACå¤–ï¼Œè¿˜æœ‰Nodeè¿™ç§ç‰¹æ®Šçš„æˆæƒæ–¹å¼ï¼Œ</p>

<p>ç»§ç»­æŸ¥æ‰¾<a href="https://kubernetes.io/docs/reference/access-authn-authz/node/">kuberneteså®˜æ–¹çš„ä¿¡æ¯</a>,å¾—çŸ¥
<div class="highlight"><pre><code class="language-bash" data-lang="bash">Node authorization is a special-purpose authorization mode that specifically authorizes API requests made by kubelets.</code></pre></div></p>
]]></content>
  </entry>
  
</feed>
